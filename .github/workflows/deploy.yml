name: Deploy to Cloudflare

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Get commit title
        id: commit
        run: |
          TITLE=$(echo "$COMMIT_MSG" | head -n 1)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}

      - name: Notify deploy start
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ vars.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üì¶ PromoBuilder  ¬∑  ‚ö°Ô∏è Live  ¬∑  üèóÔ∏è Î∞∞Ìè¨ ÏãúÏûë\n<${{ github.event.head_commit.url }}|${{ steps.commit.outputs.title }}>  by *${{ github.actor }}*"
                  }
                }
              ]
            }

      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm --filter @project-promotion/admin run typecheck && pnpm --filter @project-promotion/public run typecheck

      - name: Deploy admin app
        run: pnpm --filter @project-promotion/admin run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy public app
        run: pnpm --filter @project-promotion/public run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Notify deploy success
        if: success() && vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ vars.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üì¶ PromoBuilder  ¬∑  ‚ö°Ô∏è Live  ¬∑  ‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ\n<${{ github.event.head_commit.url }}|${{ steps.commit.outputs.title }}>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üñ•Ô∏è <https://admin.promotion.ccoshong.top|Admin> ¬∑ üåê <https://promotion.ccoshong.top|Public>"
                    }
                  ]
                }
              ]
            }

      - name: Notify deploy failure
        if: failure() && vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ vars.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üì¶ PromoBuilder  ¬∑  ‚ö°Ô∏è Live  ¬∑  ‚ùå Î∞∞Ìè¨ Ïã§Ìå®\n<${{ github.event.head_commit.url }}|${{ steps.commit.outputs.title }}>  by *${{ github.actor }}* ¬∑ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Î°úÍ∑∏ ÌôïÏù∏>"
                  }
                }
              ]
            }
